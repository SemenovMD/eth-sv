# Ethernet
Данный модуль представляет собой реализацию `Ethernet MAC` на `SystemVerilog`. Модуль поддерживает обработку `UDP/IP`, `ARP` и `ICMP`. Разработан для интеграции в FPGA, включает FIFO, проверку CRC на каждом уровне сетевой модели, а также интегрирован в `AXI-Stream`.



## Содержание
- [Особенности](#Особенности)
- [Параметры IP](#Параметры-IP)
- [Симуляция](#Симуляция)
- [Примеры python скриптов](#Примеры-python-скриптов)
- [Документация](#Документация)
- [Автор](#Автор)



## Особенности
- Поддержка одного источника в ARP-кэше
- Ограничение UDP Payload: 
  - Максимальный размер: 1024 байта
  - Требуется выравнивание по 4 байтам
- Двойное буферирование FIFO (ping pong) на 2 фрейма
- Поддержка только ICMP Truncated (`ping -s 0`)
- Полнодуплексный режим 1G Ethernet
- Автоматическое обновление ARP-кэша



## Параметры IP
- `MAC_SOURCE` - MAC адрес источника (PC).
- `MAC_DESTINATION` - MAC адрес получателя (FPGA).
- `IP_SOURCE` - IP адрес источника (PC).
- `IP_DESTINATION` - IP адрес получателя (FPGA).
- `PORT_SOURCE` - порт источника (PC).
- `PORT_DESTINATION` - порт получателя (FPGA).



## Симуляция
Для симуляции используется `QuestaSim`. Убедитесь, что путь к исполняемому файлу `vsim` добавлен в файл `bashrc`.

Для запуска симуляции Ethernet RX выполните команду:
```sh
make sim_rx
```

Для запуска симуляции Ethernet TX выполните команду:
```sh
make sim_tx
```

Для очистки файлов, полученных при симуляции выполните команду:
```sh
make clean
```



## Примеры python скриптов
### `udp_frame_rx`
Прием данных на определенный порт из FPGA, вывод их в консоль с временной меткой и сохранение в файл `udp_rx.txt`.

### `udp_frame_tx`
Передача данных из файла `udp_tx.txt` блоками по 1024 байта (дополняя нулями до кратности 4) на определенный порт в FPGA.

### `udp_frame_tx_rx`
Передача данных из файла `udp_tx.txt` блоками по 1024 байта (дополняя нулями до кратности 4) на определенный порт в FPGA, затем дальнейший прием данных из FPGA и сохранение в файл `udp_rx.txt`.



## Документация
### `rgmii_to_gmii`
Конвертер интерфейса RGMII <-> GMII с использованием примитивов IDDR и ODDR Xilinx.

### `rgmii_to_gmii_wrapper`
Оболочка на Verilog конвертера интерфейса для удобного использования в блок дизайне (IP Integrator).


### `gmii_rx_to_valid`
Конвертер GMII в поток данных с флагом валидности.

### `preamble_sfd_rx`
Детектор преамбулы (0x55) и маркера начала кадра SFD (0xD5).

### `eth_header_rx`
Парсер Ethernet-заголовка, проверка MAC адреса и типа пакета (ARP/IPv4).

### `ip_header_rx`
Парсер IPv4-заголовка, проверка IP адреса и определение типа протокола (UDP/ICMP).

### `udp_header_rx`
Парсер UDP-заголовка, проверка порта назначения.

### `conv_8_32`
Конвертер данных шириной 8 бит в 32 бита для передачи по AXI-Stream.

### `asyn_fifo_rx`
Асинхронное FIFO ping pong для приема UDP Payload между двумя тактовыми доменами через AXI-Stream.

### `arp_data_rx`
Парсер ARP-заголовка, проверка IP и MAC адреса, а также анализ ARP операции запроса/ответа.

### `arp_cache`
Хранитель MAC адреса источника, а также генерация ARP запроса/ответа.

### `arb_arp_oper`
Приоритетный арбитр между ARP запросом/ответом (приоритет на ответ).

### `icmp_rx`
Парсер ICMP-заголовка, сохранение ID, номера последовательности и генерация флага валидности для ответа.

### `fcs_rx`
Контроллер CRC32 принятого Ethernet-фрейма, а также выдача флагов верной и ошибочной контрольной суммы.

### `eth_rx`
Приемник Ethernet фреймов.


### `gmii_tx_to_valid`
Конвертер потока данных с флагом валидности в GMII.

### `preamble_sfd_tx`
Генератор преамбулы (0x55) и маркера начала кадра SFD (0xD5).

### `eth_header_tx`
Генератор Ethernet-заголовка.

### `ip_header_tx`
Генератор IPv4-заголовка.

### `udp_header_tx`
Генератор UDP-заголовка.

### `conv_32_8`
Конвертер данных шириной 32 бит в 8 бит для передачи по AXI-Stream.

### `asyn_fifo_tx`
Асинхронное FIFO ping pong для отправки UDP Payload между двумя тактовыми доменами через AXI-Stream.

### `arp_data_tx`
Генератор ARP-заголовка.

### `icmp_tx`
Генератор ICMP-заголовка.

### `fcs_tx`
Контроллер CRC32 отправленного Ethernet-фрейма.

### `mux_tx`
Мультиплексор, который последовательно формирует кадр, объединяя данные преамбулы, заголовков (Ethernet, IP, UDP/ICMP, ARP), полезной нагрузки и контрольной суммы (FCS), управляя передачей и завершением кадра.

### `eth_tx`
Передатчик Ethernet фреймов.


### `eth_udp_arp`
Приемопередатчик Ethernet фреймов.

### `eth_udp_arp_wrapper`
Оболочка на Verilog приемопередатчика Ethernet фреймов для удобного использования в блок дизайне (IP Integrator).



## Автор
- [Семёнов Максим](https://t.me/semenovmd) — FPGA Engineer